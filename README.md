# SimTools: Python Tools for Simulation Management

SimTools provide a set of tools facilitating management of simulations in
Python.

## Overview

The general goal of SimTools is to support reproducibility in computational
modeling by aiding in organization of data generated during simulations and
related metadata.

SimTools are organized into three tiers, each serving a different purpose:

- the lowest tier facilitates handling parameters and options by the simulated
  model as well as recording related metadata such as platform information and
  software versions;
- the middle tier facilitates managing a single simulation;
- the highest tier facilitates managing a batch of simulations (not implemented
  yet) as well as later extraction of model parameters used in each of the
  simulations, for example for the sake of subsequent analyses.

To meet these objectives, SimTools provide a set of classes, functions, and
console scripts.

## Handling parameters

A fundamental idea behind SimTools is that values of model parameters are kept
separate from the actual model, which is usually implemented as a script. To
this end, rather than employing a database, SimTools adopt an approach where
parameters are instead stored in regular files dedicated to this purpose.
Therefore, the file with the model itself is referred to as the _model file_ or
_model script_, whereas files storing parameters are called _parameter files_.

Parameters can be read in by the model script from a parameter file using
function `load_params()`. It returns an object of class `Params`, which is a
container storing parameters. This function supports two types of files: Python
files (`.py`) and JSON files (`.json`).

Parameters can also be saved to a file using method `Params.save()`. This
method supports only the JSON file type (`.json`).

## Handling options

Options are settings that affect behavior of the model, but are not considered
model parameters (for example, whether data generated during a simulation
should be saved to disk or not).

Options are passed to the model script as its command-line arguments. SimTools
define several built-in options, which can be recognized automatically.
Recognition of options is provided by function `parse_args()`.

The most important built-in options are the following:

- `-d` / `--data-dir` `DIR` - data directory;
- `-p` / `--params` `FILE` - parameter file;
- `-s` / `--save` - save data;
- `-i` / `--simid` `ID` - simulation id.

When calling function `parse_args()`, the model script can specify which of the
built-in options it supports and only those will be recognized.

The model script can also specify custom options that it supports internally,
beyond the built-in ones. To this end, it should create an object of class
`ArgumentParser` (provided by the Python Standard Library), populate it with
the custom options, and then pass that object as optional argument `parser` to
function `parse_args()` (provided by SimTools). This will result in adding the
built-in options (possibly restricted to a specific subset) on top of the
custom options defined by the model script and ultimately in recognizing both
sets of options.

## Recording platform information

SimTools facilitate recording information describing the platform used to
simulate the model. The information involves computer's network name,
machine type, processor name, operating system name, system's release, and
system's release version. It can be saved to a file using function
`save_platform()`.

## Recording software versions

SimTools also facilitate recording information concerning software versions.
The objective is to allow keeping track of the versions of dependencies of the
model script and possibly the version of an interpreter used for model
simulation. Such information can be saved to a file using function
`save_versions()`.

## Managing a single simulation

The main idea behind how SimTools organize data generated by the model during
a simulation and related metadata is that these pertaining to one simulation
should be stored separately from those pertaining to another simulation, that
is stored in separate directories.

An important aspect of this idea is that each simulation should be properly
identified. For this purpose, a simulation id is employed, which can be either
specified manually or generated automatically. In the case of automatic
generation, it takes the form of `YYYYMMDD_hhmmss`, where the meaning of the
constituent symbols is as follows:

- `YYYY` - year;
- `MM` - month;
- `DD` - day (of the month);
- `hh` - hour;
- `mm` - minute;
- `ss` - second.

A simulation id can be generated automatically using function
`generate_sim_id()`.

The individual directory in which data generated by the model during a single
simulation and related metadata are stored is called a _simulation directory_.
Its name can also be either specified manually or generated automatically; if
it is generated automatically, it is the same as the simulation id. Optionally,
different simulation directories can be put together in a designated parent
directory, which is called the _master directory_. Furthermore, an optional
subdirectory in the simulation directory called a _data directory_ can be
created so that data generated by the model during a simulation can be stored
separately from files containing metadata. However, this additional separation
can be attained only provided that the model script is capable of handling it
appropriately on its part: specifically, the name of the data directory must be
passed to the model script as an option and the model script must in turn
concatenate that name with the name of each file with generated data.

Altogether, the directory structure maintained by SimTools complies with the
following scheme:

```
[+ MASTERDIR]
    + SIMDIR
      [+ DATADIR]
```

where:

- `MASTERDIR` - simulation master directory (optional),
- `SIMDIR` - simulation directory,
- `DATADIR` - data directory (optional).

A particular directory structure for a single simulation can be created using
function `make_dirs()`.

To facilitate launching simulations, SimTools provide a simulation launcher,
which is a console script named `runsim`.

The simulator launcher requires one command-line argument, namely:

- `MODELFILE` - model file.

Although separation of the actual model from model parameters is highly
recommended, it is not a strict requirement of the simulator launcher. A
parameter file, however, can be specified as an optional command-line argument.
Moreover, other optional command-line arguments can also be used if launching a
simulation needs fine-tuning. The most important of the optional arguments are
the following:

- `-d` / `--data-dir` `DATADIR` - optional data directory to be created in the
  simulation directory;
- `-e` / `--exec` `EXECUTABLE` - executable to be used for running the model
  script;
- `-i` / `--simid` `ID` - simulation id, if specified manually;
- `-m` / `--master-dir` `MASTERDIR` - master directory;
- `-p` / `--params` `PARAMFILE` - parameter file;
- `-s` / `--sim-dir` `SIMDIR` - name of the simulation directory, if specified
  manually.

Optional arguments, if any, must precede argument `MODELFILE`, which is a
positional argument.

Any arguments specified after argument `MODELFILE` are considered custom
options supported internally by the model script, and therefore they are not
processed by the simulation launcher but instead are passed to the model script
directly.

The process of launching a simulation by the simulation launcher involves
several steps, the most important ones being as follows.

1. A simulation id, if not specified manually, is generated automatically, as
   is the name of a simulation directory.
2. An appropriate directory structure is created, including the simulation
   directory and, if relevant, the data directory, and then the current
   directory is changed to the simulation directory.
3. A simulation is started, either by invoking the model script directly or, if
   an executable has been specified, by invoking the executable with the model
   script as its command-line argument.

When the simulation is started, the following options are passed to the model
script:

- `--params PARAMFILE` (if specified);
- `--simid ID` (if specified manually or generated automatically);
- `--data-dir DATADIR` (if specified);
- `--save`;
- all custom options (if specified).

## Managing a batch of simulations

Managing a batch of simulations is not implemented yet. The functionality to be
provided in this regard would involve launching a batch of simulations along
with automatic substitution of individual parameters according to specified
sets of values in order to facilitate parameter sweeps.

## Exporting parameters used in a batch of simulations

Usually it is prudent to save parameters used in a particular simulation for
later reference. Such parameters, for example, can be saved to a file in the
corresponding simulation directory by the model script during the simulation.
This approach is supported by SimTools, which provide method `Params.save()`
for this purpose.

However, since for each simulation a separate simulation directory is created,
it may ultimately turn out cumbersome to compare parameter values across
multiple simulations because these parameters will be saved in different files
scattered in various directories. Therefore, to facilitate such comparisons,
for instance across a whole batch of simulations, SimTools enable exporting
parameters, that is extracting them from all the individual files and gathering
them in a single file. Importantly, not all the parameters saved in the
individual files must be exported simultaneously, as it is possible to export
only a specific subset of them. One restriction, however, is that all the
individual files must have identical names. This should typically not result in
any name collisions because these files are located in different simulation
directories.

Parameters can be exported using function `export_params()`. This function
supports saving parameters to two types of files: CSV files (`.csv`) and JSON
files (`.json`).

To facilitate exporting parameters, SimTools provide a parameter exporter,
which is a console script named `exppar`.

The parameter exporter requires the following command-line arguments:

- `PARAMNAMEFILE` - file with names of parameters to export;
- `SIMDIRFILE` - file with names of simulation directories;
- `PARAMFILE` - common name of each of the individual files with parameters;
- `EXPORTFILE` - file to which the extracted parameters should be saved.

The file with names of parameters to export should be a text file that contains
one parameter name per line. Likewise, the file with names of simulation
directories should be a text file that contains one directory name per line.

## Other utilities

SimTools also provide other utilities that can prove useful during simulations.

One example is that SimTools facilitate generating random seeds. Such random
seeds can be used to initialize pseudo-random number generators, which are
often utilized by model scripts for generating random numbers wherever needed.
An important characteristic of pseudo-random number generators is that
successive random numbers that they produce form a sequence, which is
determined by the seed used for their initialization. In other words, if a
pseudo-random number generator is initialized with the same seed, it will
generate the same sequence of random numbers. Therefore, to obtain different
sequences of random numbers during different simulations, it is necessary to
initialize the pseudo-random number generator with a random seed.

SimTools enable generating random seeds using an OS-specific randomness source,
which produces random bytes that theoretically should be so unpredictable that
they could be used even in cryptographic applications. (In theory, an
OS-specific randomness source could be employed not only for generating random
seeds, but any random numbers, thus nullifying the need for utilizing
pseudo-random number generators, but this may result in several problems, one
of which being that this source would be used so frequently that in some
systems it might exhaust the system entropy pool necessary for producing random
bytes and consequently impair generation of subsequent random numbers;
therefore, it is better to restrict the use only to generating a random seed,
and obtain other random numbers from a pseudo-random number generator, which
has been initialized with this seed.) A random seed can be generated using
function `generate_seed()`.

Sometimes a seed for a pseudo-random number generator is not generated during
model simulation, but is determined beforehand and stored as a parameter in a
parameter file. To facilitate generating a random seed using an OS-specific
randomness source in such a scenario, SimTools provide a random seed generator,
which is a console script named `genseed`. It generates a random seed and then
displays it in a textual format. If it is invoked without any arguments, the
length of the generated seed matches the number of bytes used by the largest
positive integer natively supported by the platform, namely is equal to 4 bytes
(32-bits) on 32-bit platforms and to 8 bytes (64-bits) on 64-bit platforms.
However, this length can be adjusted using the following optional command-line
argument:

- `-b` / `--bytes` `BYTES` - number of bytes of the random seed to be
  generated.

## Example

The following example involves a model demonstrating several basic features
supported by SimTools, specifically:

- separation of the actual model (implemented as a model script) from its
  parameters (stored in a parameter file);
- use of basic options (namely `params_filename`, `save_data`, and `sim_id`);
- loading parameters from the parameter file;
- employment of a simulation id;
- saving data generated by the model during a simulation;
- saving parameters;
- saving metadata (namely platform information and software versions).

The model concerns a vertical spring-mass system in a gravitational field,
which is subject to damping. The system is described by means of a second-order
ordinary differential equation based on Newton's second law of motion, where
the restoring force of the spring is determined according to Hooke's law and
damping is proportional to the velocity. The equation is numerically integrated
using forward Euler method.

The model parameters are stored in a parameter file named `params.py`:

```python
# Spring-mass system parameters
anchor_pos = 1.5  # anchor position above ground [m]
displacement = 0.4  # mass initial displacement towards ground [m]
mass = 0.3  # mass (m) [kg]
spring_const = 4.5  # spring constant (k) [N/m]
damping_coef = 0.6  # damping coefficient (c) [N*s/m]
gravity = 9.81  # gravitational acceleration (g) [m/s**2]

# Simulation parameters
sim_duration = 10.0  # simulation duration [s]
sim_dt = 0.1  # simulation time step [s]
```

The actual model is implemented as a model script, which is stored in a file
named `model.py`:

```python
import platform

import simtools

# Filenames
params_filename = "param.json"
platform_filename = "platform.json"
pos_filename = "pos.txt"
versions_filename = "version.json"

# Parameters to be saved
saved_params = ['anchor_pos', 'damping_coef', 'displacement', 'gravity',
                'mass', 'sim_dt', 'sim_duration', 'sim_id', 'spring_const']

# Process command line arguments
options = simtools.parse_args(['params_filename', 'save_data', 'sim_id'])

# Load parameters
assert options.params_filename is not None, "Parameter file is not specified."
params = simtools.load_params(options.params_filename)

# Add simulation id to parameters
params.sim_id = options.sim_id

# Validate displacement
assert params.displacement <= params.anchor_pos, \
    "Mass initial displacement must not be greater than the anchor position."

# Determine invariant quantities
gravity_force = params.mass * params.gravity

# Determine initial quantities
pos = params.anchor_pos - params.displacement
vel = 0.0

# If necessary, create a store for recording data
if options.save_data:
    pos_data = [pos]

# Run a simulation for the specified time
n_sim_steps = int(round(params.sim_duration / params.sim_dt))
for _ in range(n_sim_steps):
    # Update system state
    spring_force = -params.spring_const * (pos - params.anchor_pos)
    damping_force = params.damping_coef * vel
    net_force = spring_force - damping_force - gravity_force
    accel = net_force / params.mass
    vel += accel * params.sim_dt
    pos += vel * params.sim_dt

    # If necessary, record data
    if options.save_data:
        pos_data.append(pos)

# If necessary, save data
if options.save_data:
    # Save generated data
    with open(pos_filename, 'w') as pos_file:
        pos_file.write("\n".join("{:.6f}".format(pos) for pos in pos_data))

    # Save parameters
    params.save(params_filename, saved_params, sort_keys=True)

    # Save platform information
    simtools.save_platform(platform_filename)

    # Save software versions
    versions_info = [('python', platform.python_version()),
                     ('simtools', simtools.__version__)]
    simtools.save_versions(versions_filename, versions_info)
```

A model simulation can be launched directly as follows:

```
$ python model.py -p params.py -i 12345 -s
```

where `12345` is a manually specified simulation id. As a result, data
generated by the model during the simulation, parameters, and metadata will be
saved in the current directory:

```
+ model.py
+ param.json
+ params.py
+ platform.json
+ pos.txt
+ version.json
```

Alternatively, a model simulation can be launched by invoking the simulation
launcher provided by SimTools as follows:

```
$ runsim -p params.py -e python model.py
```

In this case, the simulation id will be generated automatically, whereas data
generated by the model during the simulation, parameters, and metadata will be
saved in an automatically created simulation directory:

```
+ YYYYMMDD_hhmmss
   + param.json
   + platform.json
   + pos.txt
   + version.json
+ model.py
+ params.py
```

where `YYYYMMDD_hhmmss` stands for the automatically generated simulation id,
as described earlier.

More examples, besides the one above, are provided in directory `examples`.
